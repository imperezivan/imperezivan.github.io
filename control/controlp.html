<html lang="es">
    <head>
        <title>Control</title>
        <meta name=viewport content="width=device-width" />
        <meta http-equiv="cache-control" content="max-age=0" />
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="expires" content="0" />
        <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
        <meta http-equiv="pragma" content="no-cache" />
        <script type="application/javascript">



            let content = [
{"a":"%r~DEwjH,91Y>unzA,)^dj9l[c,8G{Eo_iG","b":"$6yr=@&H,7_ljJ44N,7j>Tt/jq,#","c":"%$;}%c/=,9.k;m^%D,8n:0&YN=,%})1hmPi,7V%r]{w7,)j3:","d":"$6zg)z5C,&;Q3@7cC,&MeG/$E7,$6y[EL{!,7X9=<@EU,9|W1kC!M,8Z_iIhnV,}"}
,{"a":"}YfT!&T9,8h]QR]|V,7w4?L.9C,#hI4P]_$","b":"%rV&NAKV,;NT&ikUD,)6`vH^M","c":"%j2>YU6E,7Yjg*4$%,#Tnu59SP,7^ro7}j$,7id|eCgw,$>fd:m>@,}%/xF0v","d":"$43ftU4d,)0PeCtzd,0YZLZT$),7]YO7e%V,;NS4U#.j,)VEw0JEv,&dw*RenG,2SR^G*Xm,6VP#i(i.,*mnL@DxF,0?BY%>2G,5*L"}
,{"a":"5*l^[orX,8x%O/cZO,7Y~zTmIS,:pOG6!M.","b":"%>nI+dWf,7U!R~5hB,.}L>3!Cx","c":"%x0j;gBB,7p1uHpA+,$9g:IKx-,7hj(c*#R,/qD%oP0!,7|uq!#n@,%}[CUxN1,A","d":"&#f+^q=;,7[3t|%LY,7cWi)`X/,7kC|*7cC,#e[(-v2`,7Zaj19E(,$Xv@"}
,{"a":"%C%>qShA,+m.tVt<=,&{/Z|kN!,0<xTNwcv,|4^Q","b":"$Dx1GBc?,7_#:/~_w,4hO{V=~g","c":")0S5s[ws,.|imPa!*,7fVrEdT@,#vfJ`5~d,;XnQ@Zd@,#V%p>(Ty,&!$@Suhy,#&","d":"7?]7JzeS,87c?<@(v,82.D-%on,8Ecz]=S[,%)sgoz(A,$>?]SwM;,7~5V6*DB,&"}


            ];

            function getRandomToken() {
                let rndToken = "";
                for (let i = 0; i < 12; i++) {
                    const rnd = Math.floor(Math.random() * (126 - 33 + 1)) + 33;
                    rndToken += String.fromCharCode(rnd);
                }
                return rndToken;
            }

            function intArrayToStringBaseAscii(arr) {
                let base11 = arr.join(',').replaceAll(',', 'a').replaceAll('0', 'b');
                //console.log(`base11 ${base11}`)
                return splitByBlocks(base11, 14)
                    .map(block => {
                        let blockAsNum = parseInt(block, 12);
                        let blockAsAscii = toBaseAscii2(blockAsNum)
                        //console.log(`block ${block} [${blockAsNum}] [${blockAsAscii}]`)
                        return blockAsAscii;
                    })
                    .join(',');

            }

            function stringBaseAsciiToIntArray(text) {
                return text.split(',')
                    .map(blockAsAscii => {
                        let blockAsNum = toNumFromBaseAscii2(blockAsAscii);
                        let block = blockAsNum.toString(12);
                        //console.log(`block ${block} [${blockAsNum}] [${blockAsAscii}]`)
                        return block; 
                    })
                    .join('')
                    .split('a')
                    .map(numAsText => parseInt(numAsText.replaceAll('b', '0')));

            }


  
            function splitByBlocks(text, size) {
                const blocks = [];
                for (let i = 0; i < text.length; i += size) {
                    blocks.push(text.slice(i, i + size));
                }
                return blocks;
            }
 

            function toBaseAscii2(num) {
                let n = Math.trunc(num / 90)
                let res = num % 90;
                let prefix = '';
                if (n >= 1) {
                    prefix = toBaseAscii2(n);
                }
                return prefix + String.fromCharCode(res + 33)
                    .replaceAll("'", '}')
                    .replaceAll('"', '|')
                    .replaceAll(',', '{')
                    .replaceAll('\\', '~');
            }

            function toNumFromBaseAscii2(ascii) {
                ascii = ascii
                    .replaceAll('{', ',')
                    .replaceAll('|', '"')
                    .replaceAll('}', "'")
                    .replaceAll('~', '\\');
                let num = 0;
                for (let pos = ascii.length - 1; pos >= 0; pos--) {
                    let pow = ascii.length - pos - 1;
                    num += (ascii.charCodeAt(pos) - 33) * Math.pow(90, pow)
                }
                return num;
            }




            function login() {
                let pwd1 = document.getElementById('pwd1').value;


                Promise.all(
                    content.map((item, idx) => decryptData(pwd1, item).then(value => { return {value: value, index: idx}} ))
                ).then(values => 
                    values.sort((a, b) => {
                        return a.value.localeCompare(b.value);
                    }).map(text => 
                        `
                        <div>&nbsp;</div>
                        <div class="cred-item">
                                <input type="button" value="&#128203;" id="btnClipA${text.index}" class="btn" data-c="${text.value}" />
                                <input type="button" value="&#128203;" id="btnClipB${text.index}" class="btn" data-c="${text.index}"/>
                                ${text.value}
                        </div>
                        `
                    ).join('')    
                ).then(code => {
                    document.getElementById('divControl').innerHTML = code;
                    for (let i = 0; i < content.length; i++) {
                        document.getElementById(`btnClipA${i}`).addEventListener('click', (event) => {
                            let data = event.target.getAttribute('data-c');
                            copyToClipBoard(data);
                        });
                        document.getElementById(`btnClipB${i}`).addEventListener('click', (event) => {
                            let pwd2 = document.getElementById('pwd2').value;

                            let index = parseInt(event.target.getAttribute('data-c'));
                            let aux = content[index];
                            let encData = {
                                a: aux.a,
                                b: aux.b,
                                c: aux.d
                            }

                            decryptData(pwd2, encData)
                                .then(data => copyToClipBoard(data));

                        });
                    }
                });
                setTimeout(() => location.reload() , 1000 * 60 * 2);
            }

            function copyToClipBoard(data) {
                navigator.clipboard.writeText(data).then(() => {
                    console.log('Text copied to clipboard');
                }).catch((error) => {
                    console.error('Could not copy text: ', error);
                });
            }

            function init() {
                console.log('init');
                document.getElementById('btnEnter').addEventListener('click', () => {
                    login();
                });
                document.getElementById('pwd1').addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        login();
                    }
                });
                document.getElementById('pwd2').addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        login();
                    }
                });
                document.getElementById('btnEncode').addEventListener('click', () => {
                    let text1 = document.getElementById('text1').value;
                    let text2 = document.getElementById('text2').value;
                    let pwd1 = document.getElementById('pwd1').value;
                    let pwd2 = document.getElementById('pwd2').value;
                    encryptData(pwd1, pwd2, text1, text2, txt => document.getElementById('encodedText').value = txt)
                });
                document.getElementById('btnCopyEncodedText').addEventListener('click', () => {
                    let txt = document.getElementById('encodedText').value + "\n";
                    copyToClipBoard(txt);
                });
                document.getElementById('btnShowEncoder').addEventListener('click', () => {
                    document.getElementById('divEncoder').classList.remove('hidden');
                });
                document.getElementById('btnGenRamdom').addEventListener('click', () => {
                    let rndToken = getRandomToken();
                    document.getElementById('text2').value = rndToken;
                    document.getElementById('rndTokenText').innerText = rndToken;

                });
                  document.getElementById('btnCopyRandom').addEventListener('click', () => {
                    copyToClipBoard(document.getElementById('text2').value)
                    document.getElementById('rndTokenText').innerText = '';

                });

                //setTimeout(() => location.reload() , 1000 * 60 * 2);
            }


            function generateKeyFromPassword(password, salt) {
                const encoder = new TextEncoder();
                return window.crypto.subtle.importKey(
                    "raw",
                    encoder.encode(password), {
                        name: "PBKDF2"
                    },
                    false,
                    ["deriveKey"]
                ).then(keyMaterial =>
                    window.crypto.subtle.deriveKey({
                            name: "PBKDF2",
                            salt: salt,
                            iterations: 100000,
                            hash: "SHA-256",
                        },
                        keyMaterial, {
                            name: "AES-GCM",
                            length: 256
                        },
                        true,
                        ["encrypt", "decrypt"]
                    )
                );
            }

            function encryptData(password1, password2, data1, data2, consumer) {
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                let a = intArrayToStringBaseAscii(Array.from(salt));
                let b = intArrayToStringBaseAscii(Array.from(iv));

                //console.log(`salt ${Array.from(salt)}`);
                //console.log(`iv   ${Array.from(iv)}`);

                encryptData0(password1, data1, salt, iv)
                    .then(encrypted1 => {
                        encryptData0(password2, data2, salt, iv)
                            .then(encrypted2 => {
                                let rs = {
                                    a: a,
                                    b: b,
                                    c: encrypted1,
                                    d: encrypted2
                                }
                                consumer(JSON.stringify(rs));
                            });
                    })

            }

            function encryptData0(password, data, salt, iv) {
                return generateKeyFromPassword(password, salt)
                    .then(key =>
                        window.crypto.subtle.encrypt({
                                name: "AES-GCM",
                                iv: iv
                            },
                            key,
                            new TextEncoder().encode(data)
                        )
                    )
                    .then(encrypted => {
                        let arr = Array.from(new Uint8Array(encrypted))
                        //console.log(`encrypted   ${arr}`);
                        let encoded = intArrayToStringBaseAscii(arr);

                        testEncryptedData(password, salt, iv, encoded, data);
                        return encoded;
                    });
            }

            function testEncryptedData(password, salt, iv, encrypted, expected) {
                let encryptedObject = {
                    a: intArrayToStringBaseAscii(Array.from(salt)),
                    b: intArrayToStringBaseAscii(Array.from(iv)),
                    c: encrypted
                }
                decryptData(password, encryptedObject)
                    .then(decrypted => {
                        if(decrypted != expected) {
                            alert(`An error occurred testing encription. decryptData_[${decrypted}]_expected_[${expected}]`);
                        }
                    }).catch(ex => {
                        alert('An error occurred testing encription');
                        console.error(ex);
                    });
            }



            function decryptData(password, encryptedObject) {
                const salt = new Uint8Array(stringBaseAsciiToIntArray(encryptedObject.a));
                const iv = new Uint8Array(stringBaseAsciiToIntArray(encryptedObject.b));
                const encryptedData = new Uint8Array(stringBaseAsciiToIntArray(encryptedObject.c));

                //console.log(`password  [${password}]`);
                //console.log(`salt            ${Array.from(salt)}`);
                //console.log(`iv              ${Array.from(iv)}`);
                //console.log(`encryptedData   ${Array.from(encryptedData)}`);

                return generateKeyFromPassword(password, salt)
                    .then(key =>
                        window.crypto.subtle.decrypt({
                                name: "AES-GCM",
                                iv: iv
                            },
                            key,
                            encryptedData
                        )
                    ).then(decrypted => new TextDecoder().decode(decrypted))
                    .catch(ex => {
                        return Array.from(window.crypto.getRandomValues(new Uint8Array(6))).map(n => toBaseAscii2(n)).join('');
                    });
            }


        </script>

        <style type="text/css">
            #main-container {
                width: 100%;
                margin: 0px;
                padding: 0px; 
               
            }
            .container {
                max-width: 400px;
                width: 90vw;
                margin: auto;
                text-align: center;
            } 
            .hidden {
                display: none;
            }
            .text-field {
                padding-left: 5px;
                padding-top: 5px;
                padding-bottom: 5px;
                width: 90%;
                max-width: 200px;
                height: 40px;
                font-size: 1.5rem;
                margin-bottom: 10px;
                border-radius: 10px;
                border: 1px solid #dadada;
            }
            .hidden-text {
                -webkit-text-security: disc;
                text-security: square;
            }
            .cred-item {
                text-align: left;
                padding-left: 20px;
            }
            button, .btn {
                padding-left: 30px;
                padding-right: 30px;
                padding-top: 10px;
                padding-bottom: 10px;
                font-size: 1.0rem;
                border-radius: 7px;
                border: 1px solid #dadada;
            }
            
            button:active { background: #0068c0 }
            .btn:active { background: #0068c0 }
        </style>
    </head>
    <body>
        <div id="main-container"  >
            <div class="container">
                <p>&nbsp;</p>
                <label><input type="text" id="pwd1" autocomplete="off" class="hidden-text text-field" ></label>
                <label><input type="text" id="pwd2" autocomplete="off" class="hidden-text text-field"></label>
                <p></p>
                <button id="btnEnter">Enter</button>
                <button id="btnShowEncoder"> &#128273;</button>
            </div>
            <div>&nbsp;</div>
            <div id="divEncoder" class="container hidden">
                <label><input type="text" id="text1" autocomplete="off" class="text-field"></label>
                <label><input type="text" id="text2" autocomplete="off" class="text-field hidden-text" ></label>
                <p id="rndTokenText"></p>
                <button id="btnGenRamdom" >Rnd</button>
                <button id="btnCopyRandom" >&#128203;</button>
                <button id="btnEncode">Encode</button>
                <br><br>
                <label>
                    <input type="text" id="encodedText" class="text-field" >
                    <p></p>
                    <button id="btnCopyEncodedText" >&#128203;</button>
                </label>
            </div>
            <div id="divControl" class="container"></div>
        </div>




        <script type="application/javascript">
                init();
        </script>
    </body>
</html>